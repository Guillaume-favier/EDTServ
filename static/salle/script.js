/*

            ░░                                                                ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
           ░▒▒░░░░░▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒░░░░░░░▒▒▒
            ▒              ░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░                                                  ░░ ░░    ░░  ░▒
            ▒                                                                                                ░░░ ░░      ░   ▒
            ▒                                                   ░                                           ░░░░░░      ░░   ▒
            ▒                                              ░░░ ░░░   ░░░░  ░░░░   ░                          ░░  ░    ░░░   ░▒
            ▒                                              ░░░░░ ░   ░  ░  ░ ░░   ░                        ░░░ ░░░░░░░░░   ░░▒
           ░▒                 ░░░░░░░░░                    ░░ ░░ ░   ░░░░   ░░    ░                        ░ ░░░  ░░      ░░░▒
           ░▒       ░░░░░░░░░░░      ░░░░░░                ░░    ░   ░     ░░  ░  ░                         ░░  ░░ ░░░░░░░░ ░▒
           ░▒      ░░                     ░░░               ░    ░   ░     ░░░░░                               ░░  ░░   ░   ░░
           ░▒     ░░                        ░░                                                                    ░░  ░░    ▒░
           ░▒    ░░                          ░░░░                                                                ░░  ░░     ▒
           ░░    ░                              ░░░                                                                         ▒
           ▒░   ░░                                ░                                                                         ▒
           ▒░   ░░             ░░░░░░░░░        ░░░                                                                        ░▒
           ▒░    ░░░░       ░░░░       ░░░░░░░░░                                                                           ░▒
           ▒        ░░░░░░░░░                                                                  ░░                          ▒░
           ▒                              ░░░░░░░░░░░░░░░░░░░░                                ░░░░░░░░░░░░░░░░             ▒░
           ▒              ░░░░░░▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒░░░░░░░░░░░░ ░░░░░░░     ░░     ░░░       ░░░          ▒
           ▒           ░▒░░░░░                                        ░░░░░░░░░░░░░    ░░   ░░                  ░░         ▒
           ▒        ░░░░░                                 ░                    ░░       ░░▒░ ░░                  ░░░       ▒
          ░▒    ░░░░░                                   ░░░                    ░░░░ ░░░░░░░░░░░░░░                 ░░░░   ░▒
          ░▒ ░░░░░        ░                                                   ░░░▓▒░░▓▒░ ░      ░░░░░░░               ░░░░░▒
          ▒░ ░            ░░                                                  ░░░░░░░░░░ ░           ░░░░░░               ▒░
          ▒░             ░░░░                    ░░░░░░░░░░░░░░░░░░░         ░░ ░░░░░░░░░░░░░            ░░▒░░░           ▒░
          ▒░                                  ░▒░░░░░░░░░░░░░░     ░░░░      ░ ░░ ░░░   ░ ░░░░░▒▒░           ░░▒░         ▒░
          ▒                             ░░▒░░░░              ░░░░    ░░░░░░░░░░░        ░░ ░░   ░░░▒░           ░░░░      ▒
          ▒                        ░░░░░░░                  ░░░░░░         ░░░░          ░░ ░      ░░░░            ░░░░░  ▒
          ▒                      ░░░░                      ░░ ░░░░         ░ ░            ░░░░        ░░░             ░░░ ▒
          ▒                    ░░░          ░░░░  ░░░░    ░░  ░           ░░ ░             ░░░          ░                 ▒
          ▒                   ░░          ░░░  ░░░░░░░░░░░░  ░░           ░░ ░░            ░ ░          ░                 ▒
         ░▒                   ▒          ░░      ░░░░░░     ░░           ░░░░░░░          ░░░░          ░                ░▒
         ░▒                  ░░          ░░      ░░░░░░     ░           ░░   ░░░░        ░░ ▒░          ░         ░      ░▒
         ▒░              ░░ ░░            ░░   ░ ░░░░░░     ░           ░░░   ░░░░░░░░░░░░░░░░         ░░     ░░░░░      ▒░
         ▒░             ░░░░░              ░  ░░ ░░░░░░░░░░ ░░            ░░░░░░░░░░░░░░░░  ░░         ▒       ░░░░░░    ▒░
         ▒   ░░░       ░░ ░░               ░  ░░ ░      ░░░ ░                 ░░░░░      ░░░░          ░                 ▒
         ▒   ░░░░░░    ░░░░                ░░ ░░ ░      ░ ░░░                                          ░                 ▒
         ▒   ░░░░░      ░▒                  ░ ░░░░      ░ ░░░                                          ░                 ▒
         ▒              ░▒                  ░░░         ░░░                                            ░                 ▒
        ░▒             ░░▒▒                  ░░          ░░                                            ▒                ░▒
        ░▒             ░ ░░░                                                                           ░░ ░             ░▒
        ▒░             ░  ░░░░                                                                          ░░░░░   ░ ░░    ▒░
        ▒░             ░  ░▒░░░░                                                                         ░░ ░░  ░░░░░   ▒░
        ▒              ░   ░░░ ░░░                                                                        ░  ░   ░░░░   ▒
        ▒              ░   ░░░░░░░░░░                                                                    ░░  ░          ▒
        ▒                   ░░  ▒░  ░░░                                                                  ░░  ░          ▒░
        ▒                     ░░ ░░▒░ ░░░░                                                               ░   ░          ▒░
        ▒                      ░░░░ ░░░░ ░░░░░░                                                         ░░  ░░░         ░▒
        ▒      ░░ ░░░             ░░░░░░░░░░ ░░░░░░░░░                                                ░░▒  ░░            ▒
        ▒     ░░░░░░                  ░░░░ ░░░░░░   ░░░░░░░░░       ░░░░░░░                        ░░░░▒░ ░░             ▒
        ▒       ░ ░                             ░░▒░░░░     ░░▒▒▒▒▒░░░    ░░▒░░░░░              ░░░░░░░░  ░              ▒░
        ▒         ░░                                  ░░▒▒░░░░░░░     ░░░░░░░░  ░░░▒░░░░░░░░░▒▒░   ░░▒    ░              ░▒
        ▒░                                                  ░░░░░░▒▒░░░░░░░░░░▒░░     ░░░░░░░▒▒▒▒▓▒░░     ░     ░░░ ░ ░   ▒
        ▒░                                                      ░░░░░░░░░░░░░░░░░░░░░░░░░░░░           ░░░░    ░    ░  ░░ ▒
        ░▒                                                                     ░░░░                            ░░░  ░  ░░ ▒░░
        ░▒                            ░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░▓▒▒░
        ░▒ ░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░                                                           ▒░
         ▓▒▒░░░░
           2023 - 2024

*/

(async () => {
    const palette = await getJson("/palette/palettes.json");
    document.getElementsByClassName("loader")[0].style.display = "block";
    const base = await getJson("/api/v2/sallesBases/");
    document.getElementsByClassName("loader")[0].style.display = "none";
    console.log(base);
    let semaine = base["currentWeek"]+1;
    const salles = base["salles"];
    salles.sort((a, b) => a.localeCompare(b));
    const semaineNom = base["weeks"];
    // let EDT = clone(orgEDT) // variable qui stocke tout l'EDTA qui sera à consulter
    var salleSelect = document.getElementById("nomsalle");
    for (let i = 0; i < salles.length; i++) {
        // affichage primitif pour le choix des groupes
        const opt = document.createElement("option");
        opt.value = salles[i - 1];
        opt.innerText = salles[i - 1];
        salleSelect.appendChild(opt);
    }
    const ajusteDate = (n) => {
        return n < 10 ? "0" + n : n;
    };

    const cookiegrp = getCookie("salle");
    if (salles.includes(cookiegrp)) {
        salleSelect.value = cookiegrp;
    } else salleSelect.value = "";

    var semaines = document.getElementById("semaine");
    const minSemaine = 1
    const maxSemaine = semaineNom.length

    // ajout des dates semaines pour sélection.
    semaineNom.forEach((elem, i) => {
        const base = elem.split("/");
        let init = (new Date(Number("20" + base[2]), Number(base[1]) - 1, Number(base[0]))).getTime()
        let start = new Date(init)
        let end = new Date(init + 4 * 24 * 3600 * 1000)
        const opt = document.createElement("option")
        opt.value = (i + 1).toString()
        opt.innerText = "n°" + (i + 1) + " : " + ajusteDate(start.getDate()) + "/" + ajusteDate(start.getMonth() + 1) + " - " + ajusteDate(end.getDate()) + "/" + ajusteDate(end.getMonth() + 1)
        semaines.appendChild(opt)
    })

    
    // --------------------------------------------------------

    let tableauInfo = [];

    let salle = salleSelect.value;

    semaines.value = semaine;

    const metNumJours = (fullDays) => {
        const ElemEDT = document.getElementById("EDT").children[0].children;
        for (let i = 1; i < ElemEDT.length; i++) {
            const element = ElemEDT[i];
            element.innerText = fullDays[i - 1];
        }
    };

    const testparams = () => {
        return salle != 0;
    };

    const setpalette = () => {
        let namePal;
        const palcook = getCookie("palette");
        if (palcook == "" || Object.keys(palette).indexOf(palcook) == -1) {
            namePal = "Guillaume";
            setCookie("palette", "Guillaume", 100);
        } else {
            namePal = palcook;
        }
        const pal = palette[namePal];
        if (typeof pal == "undefined" || pal == null) return;
        Object.keys(pal).forEach((matiere) => {
            const mm = document.getElementsByClassName(matiere);
            for (let i = 0; i < mm.length; i++) {
                const element = mm[i];
                element.style.background = pal[matiere];
            }
        });
    };

    const updateSemaines = async () => {
        document.getElementsByClassName("alert")[0].style.display = "none";
        if (semaine > maxSemaine) semaine = minSemaine;
        if (semaine < minSemaine) semaine = maxSemaine;
        semaines.value = semaine;

        if (testparams() == false) return;

        document.getElementsByClassName("loader")[0].style.display = "block";
        const all = await getJson(
            "/api/v2/salle/?salle=" + salle + "&week=" + semaine,
        );

        document.getElementsByClassName("loader")[0].style.display = "none";
        if (!all["ok"]) {
            alert("Erreur server (" + all["error"] + ")");
        }
        console.log(all);
        afficheEDT(all["EDT"]);
        const nEDT = all["EDT"];
        const test = detectOverlap(nEDT);
        if (test.length > 0) {
            document.getElementsByClassName("alert")[0].style.display = "block";
        }
        metNumJours(all["fullDays"]);
        setpalette();
    };

    const changementPourEdt = () => {
        // fons d'écran spécialisé pour mayeul et évariste
        resetEDT();
        salle = salleSelect.value;
        updateSemaines();
    };

    semaines.onchange = (e) => {
        semaine = e.target.value;
        if (testparams() == false) {
            txt.innerText = "Paramètres invalides";
            return;
        }
        updateSemaines();
    };
    document.getElementById("nextWeek").onclick = (e) => {
        e.preventDefault();
        semaine++;
        updateSemaines();
    };

    document.getElementById("prevWeek").onclick = (e) => {
        e.preventDefault();
        semaine--;
        updateSemaines();
    };

    changementPourEdt();

    salleSelect.onchange = (e) => {
        setCookie("salleholle", e.target.value, 100);
        changementPourEdt();
    };
})();
