/*
                                                                                                                              
            ░░                                                                ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░                    
           ░▒▒░░░░░▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒░░░░░░░▒▒▒        
            ▒              ░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░                                                  ░░ ░░    ░░  ░▒         
            ▒                                                                                                ░░░ ░░      ░   ▒         
            ▒                                                   ░                                           ░░░░░░      ░░   ▒         
            ▒                                              ░░░ ░░░   ░░░░  ░░░░   ░                          ░░  ░    ░░░   ░▒         
            ▒                                              ░░░░░ ░   ░  ░  ░ ░░   ░                        ░░░ ░░░░░░░░░   ░░▒         
           ░▒                 ░░░░░░░░░                    ░░ ░░ ░   ░░░░   ░░    ░                        ░ ░░░  ░░      ░░░▒         
           ░▒       ░░░░░░░░░░░      ░░░░░░                ░░    ░   ░     ░░  ░  ░                         ░░  ░░ ░░░░░░░░ ░▒         
           ░▒      ░░                     ░░░               ░    ░   ░     ░░░░░                               ░░  ░░   ░   ░░         
           ░▒     ░░                        ░░                                                                    ░░  ░░    ▒░         
           ░▒    ░░                          ░░░░                                                                ░░  ░░     ▒          
           ░░    ░                              ░░░                                                                         ▒          
           ▒░   ░░                                ░                                                                         ▒          
           ▒░   ░░             ░░░░░░░░░        ░░░                                                                        ░▒          
           ▒░    ░░░░       ░░░░       ░░░░░░░░░                                                                           ░▒          
           ▒        ░░░░░░░░░                                                                  ░░                          ▒░          
           ▒                              ░░░░░░░░░░░░░░░░░░░░                                ░░░░░░░░░░░░░░░░             ▒░          
           ▒              ░░░░░░▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒░░░░░░░░░░░░ ░░░░░░░     ░░     ░░░       ░░░          ▒           
           ▒           ░▒░░░░░                                        ░░░░░░░░░░░░░    ░░   ░░                  ░░         ▒           
           ▒        ░░░░░                                 ░                    ░░       ░░▒░ ░░                  ░░░       ▒           
          ░▒    ░░░░░                                   ░░░                    ░░░░ ░░░░░░░░░░░░░░                 ░░░░   ░▒           
          ░▒ ░░░░░        ░                                                   ░░░▓▒░░▓▒░ ░      ░░░░░░░               ░░░░░▒           
          ▒░ ░            ░░                                                  ░░░░░░░░░░ ░           ░░░░░░               ▒░           
          ▒░             ░░░░                    ░░░░░░░░░░░░░░░░░░░         ░░ ░░░░░░░░░░░░░            ░░▒░░░           ▒░           
          ▒░                                  ░▒░░░░░░░░░░░░░░     ░░░░      ░ ░░ ░░░   ░ ░░░░░▒▒░           ░░▒░         ▒░           
          ▒                             ░░▒░░░░              ░░░░    ░░░░░░░░░░░        ░░ ░░   ░░░▒░           ░░░░      ▒            
          ▒                        ░░░░░░░                  ░░░░░░         ░░░░          ░░ ░      ░░░░            ░░░░░  ▒            
          ▒                      ░░░░                      ░░ ░░░░         ░ ░            ░░░░        ░░░             ░░░ ▒            
          ▒                    ░░░          ░░░░  ░░░░    ░░  ░           ░░ ░             ░░░          ░                 ▒            
          ▒                   ░░          ░░░  ░░░░░░░░░░░░  ░░           ░░ ░░            ░ ░          ░                 ▒            
         ░▒                   ▒          ░░      ░░░░░░     ░░           ░░░░░░░          ░░░░          ░                ░▒            
         ░▒                  ░░          ░░      ░░░░░░     ░           ░░   ░░░░        ░░ ▒░          ░         ░      ░▒            
         ▒░              ░░ ░░            ░░   ░ ░░░░░░     ░           ░░░   ░░░░░░░░░░░░░░░░         ░░     ░░░░░      ▒░            
         ▒░             ░░░░░              ░  ░░ ░░░░░░░░░░ ░░            ░░░░░░░░░░░░░░░░  ░░         ▒       ░░░░░░    ▒░            
         ▒   ░░░       ░░ ░░               ░  ░░ ░      ░░░ ░                 ░░░░░      ░░░░          ░                 ▒             
         ▒   ░░░░░░    ░░░░                ░░ ░░ ░      ░ ░░░                                          ░                 ▒             
         ▒   ░░░░░      ░▒                  ░ ░░░░      ░ ░░░                                          ░                 ▒             
         ▒              ░▒                  ░░░         ░░░                                            ░                 ▒             
        ░▒             ░░▒▒                  ░░          ░░                                            ▒                ░▒             
        ░▒             ░ ░░░                                                                           ░░ ░             ░▒             
        ▒░             ░  ░░░░                                                                          ░░░░░   ░ ░░    ▒░             
        ▒░             ░  ░▒░░░░                                                                         ░░ ░░  ░░░░░   ▒░             
        ▒              ░   ░░░ ░░░                                                                        ░  ░   ░░░░   ▒              
        ▒              ░   ░░░░░░░░░░                                                                    ░░  ░          ▒              
        ▒                   ░░  ▒░  ░░░                                                                  ░░  ░          ▒░             
        ▒                     ░░ ░░▒░ ░░░░                                                               ░   ░          ▒░             
        ▒                      ░░░░ ░░░░ ░░░░░░                                                         ░░  ░░░         ░▒             
        ▒      ░░ ░░░             ░░░░░░░░░░ ░░░░░░░░░                                                ░░▒  ░░            ▒             
        ▒     ░░░░░░                  ░░░░ ░░░░░░   ░░░░░░░░░       ░░░░░░░                        ░░░░▒░ ░░             ▒             
        ▒       ░ ░                             ░░▒░░░░     ░░▒▒▒▒▒░░░    ░░▒░░░░░              ░░░░░░░░  ░              ▒░            
        ▒         ░░                                  ░░▒▒░░░░░░░     ░░░░░░░░  ░░░▒░░░░░░░░░▒▒░   ░░▒    ░              ░▒            
        ▒░                                                  ░░░░░░▒▒░░░░░░░░░░▒░░     ░░░░░░░▒▒▒▒▓▒░░     ░     ░░░ ░ ░   ▒            
        ▒░                                                      ░░░░░░░░░░░░░░░░░░░░░░░░░░░░           ░░░░    ░    ░  ░░ ▒            
        ░▒                                                                     ░░░░                            ░░░  ░  ░░ ▒░░          
        ░▒                            ░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░▓▒▒░         
        ░▒ ░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░                                                           ▒░           
         ▓▒▒░░░░                
           2023 - 2024

*/
let url = new URL(window.location.href)
let params = new URLSearchParams(url.search);
let classeNom = params.get('classe')
console.log("Classe : "+classeNom)
const jours = ["Lundi", " Mardi", "Mercredi", "Jeudi", "Vendredi"]
var selectNom = document.getElementById("nom")

let nom = getCookie("nom")


var semaines = document.getElementById("semaine")

// for (let i = 3; i <= 35; i++) {
//     const opt = document.createElement("option")
//     opt.value = i.toString()
//     opt.innerText = i
//     semaines.appendChild(opt)
// }

var paletteElem = document.getElementById("palette")

const ajusteDate = (n) => {
    return n < 10 ? "0"+ n : n
}

const txt = document.getElementById("outTxt")

; (async () => {
    document.getElementsByClassName("loader")[0].style.display = "block"
    const palette = await getJson("/palette/palettes.json")
    const base = await getJson("/api/v2/classe/"+classeNom)
    document.getElementsByClassName("loader")[0].style.display = "none"
    // console.log(base)
    let semaine = base["currentWeek"]+1;
    const noms = base["noms"]
    let ok = true
    if (!noms.includes(nom)) {
        ok = false
        nom = ""
    }
    for (let i = 0; i < noms.length; i++) {
        const element = noms[i];
        const option = document.createElement("option")
        option.value = element
        option.innerText = element
        selectNom.appendChild(option)
        if (ok && nom == element) {
            selectNom.value = nom
        }
    }
    const semaineNom = base["weeks"]
    const minSemaine = 1
    const maxSemaine = semaineNom.length

    // ajout des dates semaines pour sélection.
    semaineNom.forEach((elem, i) => {
        const base = elem.split("/");
        let init = (new Date(Number("20" + base[2]), Number(base[1]) - 1, Number(base[0]))).getTime()
        let start = new Date(init)
        let end = new Date(init + 4 * 24 * 3600 * 1000)
        const opt = document.createElement("option")
        opt.value = (i + 1).toString()
        opt.innerText = "n°" + (i + 1) + " : " + ajusteDate(start.getDate()) + "/" + ajusteDate(start.getMonth() + 1) + " - " + ajusteDate(end.getDate()) + "/" + ajusteDate(end.getMonth() + 1)
        semaines.appendChild(opt)
    })

    // let EDT = clone(orgEDT) // variable qui stocke tout l'EDTA qui sera à consulter
    txt.innerHTML = "Traitement des données ..."
    let cache = {}

    let currNom = selectNom.value == "" ? 0 : Number(selectNom.value);
    document.getElementById("semaine").value = semaine.toString()

    const metNumJours = (fullDays) => { // affiche le jour en haut de l'EDT
        const ElemEDT = document.getElementById("EDT").children[0].children
        for (let i = 1; i < ElemEDT.length; i++) {
            const element = ElemEDT[i];
            element.innerText = fullDays[i-1]
        }
    }

    txt.innerHTML = "Veuillez choisir quelqu'un"
    const testparams = () => {
        return currNom != 0
    }

    const setpalette = () => {
        const palcook = getCookie("palette")
        let namePal = ""
        if (palcook == "" || Object.keys(palette).indexOf(palcook) == -1) {
            namePal = "Guillaume"
            setCookie("palette", "Guillaume", 100)
        } else {
            namePal = palcook
        }
        const pal = palette[namePal]
        if (typeof pal == "undefined" || pal == null) return
        Object.keys(pal).forEach(matiere => {
            const mm = document.getElementsByClassName(matiere)
            for (let i = 0; i < mm.length; i++) {
                const element = mm[i];
                element.style.background = pal[matiere]
            }
        })
    }

    const updateSemaines = async () => {
        document.getElementsByClassName("alert")[0].style.display = "none"
        document.getElementsByClassName("warning")[0].style.display = "none"
        let ele = document.getElementById("persGrp");
        ele.innerHTML = ""
        document.getElementById("DownEDT").onclick = () => {}
        if (currNom == "") {
            txt.innerText = "Veuillez choisir un groupe de kholle"
            return
        }
        txt.innerText = ""
        if (semaine > maxSemaine) semaine = minSemaine
        if (semaine < minSemaine) semaine = maxSemaine
        semaines.value = semaine
        
        if (testparams() == false) return
        let cacheName = currNom + "-" + semaine
        let all
        if (Object.keys(cache).includes(cacheName)) {
            all = cache[cacheName]
        }else{
            document.getElementsByClassName("loader")[0].style.display = "block"
            all = await getJson("/api/v2/classe/"+classeNom+"/EDT?pers=" + currNom+"&week="+semaine)
            // console.log(all)
            document.getElementsByClassName("loader")[0].style.display = "none"
            cache[cacheName] = all
        }
        if (!all["ok"]) {
            alert("Erreur server (" + all["error"]+")")
        }
        if (all["message"] != "") {
            document.getElementById("warningText").innerText = all["message"]
            document.getElementsByClassName("warning")[0].style.display = "block"
        }
        // affichage
        afficheEDT(all["EDT"])

        // détection des conflits
        let de = detectOverlap(all["EDT"])
        if (de.length > 0) {
            console.log(de)
            let p = "Nottament du à : \n"
            for (let n = 0; n < de.length; n++) {
                p += " - Le " + jours[de[n][2]] + " entre " + de[n][0][0] + " [" + nombreToHeure(de[n][0][3]) + "-" + nombreToHeure(de[n][0][4]) + "] et " + de[n][1][0] + " [" + nombreToHeure(de[n][1][3]) + "-" + nombreToHeure(de[n][1][4]) + "]\n"
            }
            document.getElementById("colisionText").innerText = p
            console.log(document.getElementsByClassName("alert")[0])

            document.getElementsByClassName("alert")[0].style.display = "block"
        }
        
        fromEDTtoIcs(all["EDT"], semaineNom[semaine - 1])

        metNumJours(all["fullDays"])
        setpalette()

        // affichage des kholles sous forme de liste
        let ul = document.createElement("ul")
        all["kholles"].forEach((days,jour) => {
            for (let i = 0; i < days.length; i++) {
                const kh = days[i];
                const li = document.createElement("li")
                li.innerText = kh[0] + ", le " + jours[jour] + " à  " + nombreToHeure(kh[3]) + " en " + kh[2] + " avec " + kh[5]
                ul.appendChild(li)
            }
        })
        txt.appendChild(document.createTextNode("DS : "+(all["DS"] == null ? "Aucun" : all["DS"])))
        txt.appendChild(ul)

        // affichage des membres du groupe en bas de la page
        let p = document.createElement("p")
        p.innerText = "Personnes du groupe :"
        all["membres"].forEach(pers => {
            p.innerText += "\t " + pers[1] + " " + pers[0] + ". ," 
        })
        p.innerText = p.innerText.substring(0, p.innerText.length - 2)
        ele.appendChild(p)
    }

    const changementPourEdt = () => { // fons d'écran spécialisé pour mayeul et évariste
        resetEDT()
        currNom = selectNom.value
        updateSemaines()
        if (currNom == "Evariste C."){
            document.body.className = "manchot"
        }
        else if (currNom == "Mayeul A.") {
            document.body.className = "chateauuu"
        }
        else if (currNom == "Jules F.") {
            document.body.className = "KCWIN"
        }
        else {
            document.body.className = ""
        }

    }

    semaines.onchange = e => {
        semaine = e.target.value;
        if (testparams() == false) {
            txt.innerText = "Paramètres invalides"
            return
        }
        updateSemaines()
    }
    document.getElementById("nextWeek").onclick = e=> {
        e.preventDefault()
        semaine++
        updateSemaines()
    }

    document.getElementById("prevWeek").onclick = e => {
        e.preventDefault()
        semaine--
        updateSemaines()
    }


    changementPourEdt()


    selectNom.onchange = e => {
        setCookie("nom", e.target.value, 100)
        changementPourEdt()
    }
    
})()