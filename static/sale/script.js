/*
                                                                                                                              
            ░░                                                                ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░                    
           ░▒▒░░░░░▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒░░░░░░░▒▒▒        
            ▒              ░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░                                                  ░░ ░░    ░░  ░▒         
            ▒                                                                                                ░░░ ░░      ░   ▒         
            ▒                                                   ░                                           ░░░░░░      ░░   ▒         
            ▒                                              ░░░ ░░░   ░░░░  ░░░░   ░                          ░░  ░    ░░░   ░▒         
            ▒                                              ░░░░░ ░   ░  ░  ░ ░░   ░                        ░░░ ░░░░░░░░░   ░░▒         
           ░▒                 ░░░░░░░░░                    ░░ ░░ ░   ░░░░   ░░    ░                        ░ ░░░  ░░      ░░░▒         
           ░▒       ░░░░░░░░░░░      ░░░░░░                ░░    ░   ░     ░░  ░  ░                         ░░  ░░ ░░░░░░░░ ░▒         
           ░▒      ░░                     ░░░               ░    ░   ░     ░░░░░                               ░░  ░░   ░   ░░         
           ░▒     ░░                        ░░                                                                    ░░  ░░    ▒░         
           ░▒    ░░                          ░░░░                                                                ░░  ░░     ▒          
           ░░    ░                              ░░░                                                                         ▒          
           ▒░   ░░                                ░                                                                         ▒          
           ▒░   ░░             ░░░░░░░░░        ░░░                                                                        ░▒          
           ▒░    ░░░░       ░░░░       ░░░░░░░░░                                                                           ░▒          
           ▒        ░░░░░░░░░                                                                  ░░                          ▒░          
           ▒                              ░░░░░░░░░░░░░░░░░░░░                                ░░░░░░░░░░░░░░░░             ▒░          
           ▒              ░░░░░░▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒░░░░░░░░░░░░ ░░░░░░░     ░░     ░░░       ░░░          ▒           
           ▒           ░▒░░░░░                                        ░░░░░░░░░░░░░    ░░   ░░                  ░░         ▒           
           ▒        ░░░░░                                 ░                    ░░       ░░▒░ ░░                  ░░░       ▒           
          ░▒    ░░░░░                                   ░░░                    ░░░░ ░░░░░░░░░░░░░░                 ░░░░   ░▒           
          ░▒ ░░░░░        ░                                                   ░░░▓▒░░▓▒░ ░      ░░░░░░░               ░░░░░▒           
          ▒░ ░            ░░                                                  ░░░░░░░░░░ ░           ░░░░░░               ▒░           
          ▒░             ░░░░                    ░░░░░░░░░░░░░░░░░░░         ░░ ░░░░░░░░░░░░░            ░░▒░░░           ▒░           
          ▒░                                  ░▒░░░░░░░░░░░░░░     ░░░░      ░ ░░ ░░░   ░ ░░░░░▒▒░           ░░▒░         ▒░           
          ▒                             ░░▒░░░░              ░░░░    ░░░░░░░░░░░        ░░ ░░   ░░░▒░           ░░░░      ▒            
          ▒                        ░░░░░░░                  ░░░░░░         ░░░░          ░░ ░      ░░░░            ░░░░░  ▒            
          ▒                      ░░░░                      ░░ ░░░░         ░ ░            ░░░░        ░░░             ░░░ ▒            
          ▒                    ░░░          ░░░░  ░░░░    ░░  ░           ░░ ░             ░░░          ░                 ▒            
          ▒                   ░░          ░░░  ░░░░░░░░░░░░  ░░           ░░ ░░            ░ ░          ░                 ▒            
         ░▒                   ▒          ░░      ░░░░░░     ░░           ░░░░░░░          ░░░░          ░                ░▒            
         ░▒                  ░░          ░░      ░░░░░░     ░           ░░   ░░░░        ░░ ▒░          ░         ░      ░▒            
         ▒░              ░░ ░░            ░░   ░ ░░░░░░     ░           ░░░   ░░░░░░░░░░░░░░░░         ░░     ░░░░░      ▒░            
         ▒░             ░░░░░              ░  ░░ ░░░░░░░░░░ ░░            ░░░░░░░░░░░░░░░░  ░░         ▒       ░░░░░░    ▒░            
         ▒   ░░░       ░░ ░░               ░  ░░ ░      ░░░ ░                 ░░░░░      ░░░░          ░                 ▒             
         ▒   ░░░░░░    ░░░░                ░░ ░░ ░      ░ ░░░                                          ░                 ▒             
         ▒   ░░░░░      ░▒                  ░ ░░░░      ░ ░░░                                          ░                 ▒             
         ▒              ░▒                  ░░░         ░░░                                            ░                 ▒             
        ░▒             ░░▒▒                  ░░          ░░                                            ▒                ░▒             
        ░▒             ░ ░░░                                                                           ░░ ░             ░▒             
        ▒░             ░  ░░░░                                                                          ░░░░░   ░ ░░    ▒░             
        ▒░             ░  ░▒░░░░                                                                         ░░ ░░  ░░░░░   ▒░             
        ▒              ░   ░░░ ░░░                                                                        ░  ░   ░░░░   ▒              
        ▒              ░   ░░░░░░░░░░                                                                    ░░  ░          ▒              
        ▒                   ░░  ▒░  ░░░                                                                  ░░  ░          ▒░             
        ▒                     ░░ ░░▒░ ░░░░                                                               ░   ░          ▒░             
        ▒                      ░░░░ ░░░░ ░░░░░░                                                         ░░  ░░░         ░▒             
        ▒      ░░ ░░░             ░░░░░░░░░░ ░░░░░░░░░                                                ░░▒  ░░            ▒             
        ▒     ░░░░░░                  ░░░░ ░░░░░░   ░░░░░░░░░       ░░░░░░░                        ░░░░▒░ ░░             ▒             
        ▒       ░ ░                             ░░▒░░░░     ░░▒▒▒▒▒░░░    ░░▒░░░░░              ░░░░░░░░  ░              ▒░            
        ▒         ░░                                  ░░▒▒░░░░░░░     ░░░░░░░░  ░░░▒░░░░░░░░░▒▒░   ░░▒    ░              ░▒            
        ▒░                                                  ░░░░░░▒▒░░░░░░░░░░▒░░     ░░░░░░░▒▒▒▒▓▒░░     ░     ░░░ ░ ░   ▒            
        ▒░                                                      ░░░░░░░░░░░░░░░░░░░░░░░░░░░░           ░░░░    ░    ░  ░░ ▒            
        ░▒                                                                     ░░░░                            ░░░  ░  ░░ ▒░░          
        ░▒                            ░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░▓▒▒░         
        ░▒ ░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░                                                           ▒░           
         ▓▒▒░░░░                
           2023 - 2024

*/


function setCookie(cname, cvalue, exdays) {
    const d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    let expires = "expires=" + d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

function getCookie(cname) {
    let name = cname + "=";
    let ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

function clone(a) {
    return JSON.parse(JSON.stringify(a));
}

const heureToNombre = (n) => {
    if (typeof n == typeof 2) return n
    if (n.indexOf("h") > -1) {
        let nn = n.split("h")
        return Number(nn[0]) + (Number(nn[1]) / 60)
    } return Number(n)
}

const nombreToHeure = (n) => {
    let reste = n - Math.floor(n)
    if (reste > 0) return Math.floor(n).toString() + "h" + Math.round(reste * 60)
    return Math.floor(n).toString() + "h"
}
jours = ["Lundi", " Mardi", "Mercredi", "Jeudi", "Vendredi"]

async function getJson(url) {
    const response = await fetch(url);
    const jj = await response.json();
    return jj
}


async function getText(url) {
    const response = await fetch(url);
    const txt = await response.text();
    return txt
}





; (async () => {
    const pallette = await getJson("palettes.json")
    const base = await getJson("/api/v1/salesBases/")
    console.log(base)
    let semaine = base["currentWeek"];
    const salles = base["salles"]
    salles.sort((a, b) => a.localeCompare(b))
    const semaineNom = base["weeks"]
    // let EDT = clone(orgEDT) // variable qui stocke tout l'EDTA qui sera à consulter
    var salleSelect = document.getElementById("nomSale")
    for (let i = 0; i < salles.length; i++) { // affichage primitif pour le choix des groupes
        const opt = document.createElement("option")
        opt.value = salles[i - 1]
        opt.innerText = salles[i - 1]
        salleSelect.appendChild(opt)
    }

    const cookiegrp = getCookie("salle")
    if (cookiegrp == "" || (Number(cookiegrp) < 17 && Number(cookiegrp) > 0)) {
        salleSelect.value = cookiegrp
    } else salleSelect.value = ""

    var semaines = document.getElementById("semaine")
    for (let i = 3; i < 19; i++) {

        const opt = document.createElement("option")
        opt.value = i.toString()
        opt.innerText = i
        semaines.appendChild(opt)
    }
    var palletteElem = document.getElementById("pallette")

    const ajusteDate = (n) => {
        return n < 10 ? "0" + n : n
    }
    // --------------------------------------------------------

    let tableauInfo = []

    let salle = salleSelect.value;
    
    semaines.value = semaine

    const metNumJours = (fullDays) => {
        const ElemEDT = document.getElementById("EDT").children[0].children
        for (let i = 1; i < ElemEDT.length; i++) {
            const element = ElemEDT[i];
            element.innerText = fullDays[i-1]
        }
    }

    const testparams = () => {
        return salle != 0
    }

    const resetEDT = () => {
        const copy = document.getElementById("EDT2").cloneNode(true);
        document.getElementById("EDT").remove()
        document.getElementById("tocopy").appendChild(copy)
        document.getElementById("EDT2").id = "EDT"

    }

    const afficheEDT = (table) => {
        console.log("affichage", table)
        console.log("Affichage de l'emplois du temps")
        resetEDT()

        const joursN = ["lundi", "mardi", "mercredi", "jeudi", "vendredi"]

        let eEDT = document.getElementById("EDT")
        let start = 7.75
        let last = [start, start, start, start]
        for (let i = start; i < 19.25; i += 0.25) { // De 8h à 19h
            let tr = document.createElement("tr") // ligne pour toute la semaine

            const heure = document.createElement("td")
            tr.className += "trHeure"
            if (i - Math.floor(i) < 0.01) { // si l'heure est ronde
                heure.className = "heure"
                heure.innerText = i + "h" //colonne de gauche des heures
            } else {
                heure.className = "Fakheure"
                heure.innerText = "\n"
            }
            tr.appendChild(heure)
            for (let jour = 0; jour < 5; jour++) { // pour toutes les journées
                let done = false
                for (let numE = 0; numE < table[jour].length; numE++) { // cherche à partir de tout les cours de la journée
                    const element = table[jour][numE];
                    console.log("pour ", nombreToHeure(i), "et", element[3], nombreToHeure(element[2]),"pour",element)
                    if (Math.abs(i - element[3]) < 0.125) {
                        console.log("ajout", element)
                        done = true
                        last[jour] = element[4]
                        const coursMatiere = element[1]
                        const td = document.createElement("td")
                        td.className = "cours " + coursMatiere
                        td.innerText = element[0] + "\n (" + element[2] + ")\n" + nombreToHeure(element[3]) + " - " + nombreToHeure(element[4])
                        const n = Math.round(4 * (element[4] - element[3]))
                        if (n != 1) td.rowSpan = n
                        tr.appendChild(td)
                        break


                    }
                }
                if (done == false && last[jour] <= i) {
                    console.log("skip")
                    last[jour] += 0.25
                    const td = document.createElement("td")
                    td.innerText = "\n"
                    tr.appendChild(td)
                    continue
                }
            }
            eEDT.appendChild(tr)
        }
    }


    // affichage pallette
    Object.keys(pallette).forEach(name => {
        const option = document.createElement("option")
        option.value = name
        option.innerText = name
        palletteElem.appendChild(option)
    })

    const setPallette = () => {
        const palcook = getCookie("pallette")
        if (palcook == "" || Object.keys(pallette).indexOf(palcook) == -1) {
            palletteElem.value = "Guillaume"
            setCookie("pallette", "Guillaume", 100)
        } else {
            palletteElem.value = palcook
        }

        const namePal = palletteElem.value
        const pal = pallette[namePal]
        if (typeof pal == "undefined" || pal == null) return
        Object.keys(pal).forEach(matiere => {
            const mm = document.getElementsByClassName(matiere)
            for (let i = 0; i < mm.length; i++) {
                const element = mm[i];
                element.style.background = pal[matiere]
            }
        })
    }

    const updateSemaines = async () => {
        if (semaine > 18) semaine = 3
        if (semaine < 3) semaine = 18
        semaines.value = semaine
        
        if (testparams() == false) return
        const all = await getJson("/api/v1/sale/?sale=" + salle+"&week="+semaine)
        if (!all["ok"]) {
            alert("Erreur server (" + all["error"]+")")
        }
        console.log(all)
        afficheEDT(all["EDT"])
        const nEDT = all["EDT"]

        metNumJours(all["fullDays"])
        setPallette()
    }

    const changementPourEdt = () => { // fons d'écran spécialisé pour mayeul et évariste
        resetEDT()
        salle = salleSelect.value
        updateSemaines()

    }

    semaines.onchange = e => {
        semaine = e.target.value;
        if (testparams() == false) {
            txt.innerText = "Paramètres invalides"
            return
        }
        updateSemaines()
    }
    document.getElementById("nextWeek").onclick = e=> {
        e.preventDefault()
        semaine++
        updateSemaines()
    }

    document.getElementById("prevWeek").onclick = e => {
        e.preventDefault()
        semaine--
        updateSemaines()
    }


    changementPourEdt()

    salleSelect.onchange = e => {
        setCookie("salleholle", e.target.value, 100)
        changementPourEdt()
    }
    palletteElem.onchange = e => {
        setCookie("pallette", palletteElem.value, 100)
        updateSemaines()
    }

    // ajout des dates semaines pour sélection.
    semaines.childNodes.forEach(elem => {
        const base = semaineNom[elem.value - 2].split("/");
        let init = (new Date(Number("20" + base[2]), Number(base[1]) - 1, Number(base[0]))).getTime()
        let start = new Date(init)
        let end = new Date(init + 4 * 24 * 3600 * 1000)
        elem.innerText = "n°"+elem.value + " : " +ajusteDate(start.getDate()) + "/" + ajusteDate(start.getMonth() + 1) + " - " + ajusteDate(end.getDate()) + "/" + ajusteDate(end.getMonth() + 1)
    })
})()